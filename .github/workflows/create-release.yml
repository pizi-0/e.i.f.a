name: Create GitHub Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'The version tag for this release (e.g., v1.0.0)'
        required: true
        type: string
      build_run_id:
        description: 'The run ID of the "Release Build" workflow to get artifacts from'
        required: true
        type: string

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      actions: read # Required to download artifacts from other workflows
      contents: write # Required to create a release
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          repository: ${{ github.repository }}
          github-token: ${{ github.token }}
          run-id: ${{ github.event.inputs.build_run_id }}
          path: artifacts/

      - name: List downloaded artifacts
        run: ls -R artifacts/

      - name: Prepare artifacts for release
        run: |
          mkdir -p artifacts/release_assets
          mv artifacts/eifa-linux-x86_64/eifa artifacts/release_assets/eifa-linux-x86_64
          mv artifacts/eifa-macos-x86_64/eifa artifacts/release_assets/eifa-macos-x86_64
          mv artifacts/eifa-macos-aarch64/eifa artifacts/release_assets/eifa-macos-aarch64
          mv artifacts/eifa-windows-x86_64/eifa.exe artifacts/release_assets/eifa-windows-x86_64.exe
          # Optional: remove the now empty subdirectories
          rmdir artifacts/eifa-linux-x86_64 || true
          rmdir artifacts/eifa-macos-x86_64 || true
          rmdir artifacts/eifa-macos-aarch64 || true
          rmdir artifacts/eifa-windows-x86_64 || true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: Release ${{ github.event.inputs.version }}
          body: "Official release for version ${{ github.event.inputs.version }}"
          files: |
            artifacts/release_assets/eifa-linux-x86_64
            artifacts/release_assets/eifa-macos-x86_64
            artifacts/release_assets/eifa-macos-aarch64
            artifacts/release_assets/eifa-windows-x86_64.exe
